<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kanban Sklad</title>
    <!-- Knihovny -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        :root {
            --green: #10B981; --yellow: #F59E0B; --red: #EF4444;
            --bg: #F3F4F6; --card: #ffffff; --text: #1F2937;
        }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        header { background: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.2rem; color: #333; }
        .header-actions { display: flex; gap: 10px; }
        .btn-action { padding: 8px 12px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; font-size: 0.9rem; }
        .btn-scan { background: #8B5CF6; }
        .btn-print { background: #374151; }

        /* KANBAN STAVY */
        .status-bar { display: flex; gap: 5px; padding: 10px; background: white; margin-bottom: 10px; justify-content: space-around; font-size: 0.8rem; font-weight: bold; color: #555; }
        .stat-box { text-align: center; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        /* ITEM CARD */
        .grid { display: grid; grid-template-columns: 1fr; gap: 10px; padding: 10px; }
        @media(min-width:600px) { .grid { grid-template-columns: 1fr 1fr; } }

        .card { 
            background: white; padding: 15px; border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 8px solid gray;
            transition: 0.3s;
        }
        
        /* Barvy lev√©ho pruhu podle stavu */
        .card[data-status="green"] { border-left-color: var(--green); }
        .card[data-status="yellow"] { border-left-color: var(--yellow); }
        .card[data-status="red"] { border-left-color: var(--red); background: #FEF2F2; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-name { font-weight: bold; font-size: 1.1rem; }
        .card-status-text { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; color: #555; }
        
        /* Tlaƒç√≠tka stav≈Ø */
        .status-btns { display: flex; gap: 5px; margin-top: 10px; }
        .s-btn { flex: 1; padding: 8px; border: 1px solid #ddd; background: white; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
        .s-btn.active { color: white; border-color: transparent; }
        .s-btn.green.active { background: var(--green); }
        .s-btn.yellow.active { background: var(--yellow); }
        .s-btn.red.active { background: var(--red); }

        /* TISK (Kanban karty) */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
            
            .kanban-card { 
                border: 2px dashed black; padding: 15px; text-align: center; 
                page-break-inside: avoid; height: 200px; display: flex; flex-direction: column; 
                justify-content: center; align-items: center; 
            }
            .kc-title { font-size: 18pt; font-weight: bold; margin-bottom: 10px; }
            .kc-desc { font-size: 12pt; margin-bottom: 10px; }
            .kc-barcode { height: 50px; width: 80%; }
        }

        /* MODALS */
        #scanner-modal, #login-overlay, #print-setup { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 1000; display: none; 
            flex-direction: column; justify-content: center; align-items: center; 
        }
        #reader { width: 100%; max-width: 500px; background: black; }
        .modal-box { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .modal-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; box-sizing: border-box; }
        .btn-full { width: 100%; padding: 12px; background: var(--green); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .close-btn { margin-top: 20px; background: transparent; border: 1px solid white; color: white; padding: 10px; cursor: pointer; }

        /* ADD BAR */
        .add-bar { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; display: flex; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        .add-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .btn-add { background: var(--green); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; font-size: 1.5rem; }

    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="login-overlay" style="display: flex;">
        <div class="modal-box">
            <h2>üîê Sklad Login</h2>
            <input type="text" id="u" placeholder="Jm√©no">
            <input type="password" id="p" placeholder="Heslo">
            <button class="btn-full" style="background:var(--green)" onclick="login()">Vstoupit</button>
        </div>
    </div>

    <!-- 2. SKENER -->
    <div id="scanner-modal">
        <div id="reader"></div>
        <button class="close-btn" onclick="stopScanner()">Zav≈ô√≠t kameru</button>
    </div>

    <!-- 3. OKNO PRO TISK -->
    <div id="print-setup">
        <div class="modal-box">
            <h3>üñ®Ô∏è Tisk Kanban karet</h3>
            <p>Vyberte produkt pro tisk karty:</p>
            <select id="print-select" style="width:100%; padding:10px; margin-bottom:10px;"></select>
            
            <p>Typ karty (kam ji vlo≈æ√≠te):</p>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-full" style="background:var(--yellow); color:black;" onclick="preparePrint('yellow')">‚ö†Ô∏è Karta "DOCH√ÅZ√ç"</button>
                <button class="btn-full" style="background:var(--red);" onclick="preparePrint('red')">üõë Karta "KOUPIT"</button>
            </div>
            
            <button class="btn-full" style="background:gray" onclick="document.getElementById('print-setup').style.display='none'">Zru≈°it</button>
        </div>
    </div>

    <!-- SKRYT√Å OBLAST PRO TISK -->
    <div id="print-area"></div>

    <!-- 4. HLAVN√ç APP -->
    <div id="app" style="display:none;">
        <header>
            <div class="header-top">
                <h1>üì¶ Kanban Sklad</h1>
                <div class="header-actions">
                    <button class="btn-action btn-print" onclick="openPrintModal()">üñ®Ô∏è Karty</button>
                    <button class="btn-action btn-scan" onclick="startScanner()">üì∑ Sken</button>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="search" placeholder="üîç Hledat..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px;" oninput="render()">
                <button class="btn-action" style="background:#3B82F6;" onclick="sendEmail()" id="btnEmail">üìß Odeslat</button>
            </div>
        </header>

        <div class="status-bar">
            <div class="stat-box"><span class="dot" style="background:var(--green)"></span>M√°me: <b id="c-green">0</b></div>
            <div class="stat-box"><span class="dot" style="background:var(--yellow)"></span>Doch√°z√≠: <b id="c-yellow">0</b></div>
            <div class="stat-box"><span class="dot" style="background:var(--red)"></span>Koupit: <b id="c-red">0</b></div>
        </div>

        <div id="grid" class="grid"></div>

        <div class="add-bar">
            <input type="text" id="newName" class="add-input" placeholder="Nov√Ω produkt...">
            <button class="btn-add" onclick="addItem()">+</button>
        </div>
    </div>

    <script>
        // --- KONFIGURACE (VA≈†E KL√çƒåE) ---
        const USER = "dole";
        const PASS = "01";
        
        // Data (Pantry)
        const PANTRY_ID = "7a5aa8af-6120-4aef-9372-9520d1fb3f2d";
        const API_URL = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/kanban_v2`;

        // EmailJS
        const EMAIL_SERVICE_ID = "service_wzg8ove";
        const EMAIL_TEMPLATE_ID = "template_71jc7wb";
        const EMAIL_PUBLIC_KEY = "o1EMgg8G3ffAloJPI";

        let inventory = [];
        let html5QrCode;

        // --- INIT ---
        (function(){
            try { emailjs.init(EMAIL_PUBLIC_KEY); } catch(e){ console.error("EmailJS Init Error", e); }
            if(localStorage.getItem('kanban_logged') === 'true') showApp();
        })();

        // --- AUTH ---
        function login() {
            if(document.getElementById('u').value === USER && document.getElementById('p').value === PASS) {
                localStorage.setItem('kanban_logged', 'true');
                showApp();
            } else alert("Chyba!");
        }
        function showApp() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            loadData();
        }

        // --- DATA ---
        async function loadData() {
            try {
                const res = await fetch(API_URL + "?t=" + Date.now());
                if(res.ok) {
                    const data = await res.json();
                    inventory = data.items || [];
                } else inventory = [];
                render();
            } catch(e) { console.error(e); }
        }

        async function saveData() {
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ items: inventory })
                });
            } catch(e) {}
        }

        // --- RENDER ---
        function render() {
            const grid = document.getElementById('grid');
            const term = document.getElementById('search').value.toLowerCase();
            grid.innerHTML = '';
            
            let counts = { green:0, yellow:0, red:0 };

            // Sort: Red first
            const sorted = [...inventory].sort((a,b) => {
                const map = { red:0, yellow:1, green:2 };
                return map[a.status] - map[b.status];
            });

            sorted.forEach(item => {
                if(!item.name.toLowerCase().includes(term)) return;
                counts[item.status]++;

                const div = document.createElement('div');
                div.className = 'card';
                div.setAttribute('data-status', item.status);
                
                let statusText = item.status === 'green' ? '‚úÖ OK' : (item.status === 'yellow' ? '‚ö†Ô∏è Doch√°z√≠' : 'üõë KOUPIT');

                div.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-name">${item.name}</div>
                            <div class="card-status-text">${statusText}</div>
                        </div>
                        <button onclick="delItem('${item.id}')" style="border:none; background:none; color:#999;">‚úñ</button>
                    </div>
                    
                    <div class="status-btns">
                        <button class="s-btn green ${item.status==='green'?'active':''}" onclick="setStatus('${item.id}', 'green')">M√°me</button>
                        <button class="s-btn yellow ${item.status==='yellow'?'active':''}" onclick="setStatus('${item.id}', 'yellow')">Doch√°z√≠</button>
                        <button class="s-btn red ${item.status==='red'?'active':''}" onclick="setStatus('${item.id}', 'red')">Koupit</button>
                    </div>
                `;
                grid.appendChild(div);
            });

            document.getElementById('c-green').innerText = counts.green;
            document.getElementById('c-yellow').innerText = counts.yellow;
            document.getElementById('c-red').innerText = counts.red;
        }

        // --- ACTIONS ---
        async function setStatus(id, status) {
            const item = inventory.find(i => i.id === id);
            if(item && item.status !== status) {
                item.status = status;
                render();
                await saveData();
            }
        }

        async function addItem() {
            const name = document.getElementById('newName').value.trim();
            if(!name) return;
            const id = Math.floor(Math.random()*10000).toString().padStart(4,'0');
            inventory.unshift({ id, name, status: 'green' });
            document.getElementById('newName').value = '';
            render();
            await saveData();
        }
        
        async function delItem(id) {
            if(confirm("Smazat produkt?")) {
                inventory = inventory.filter(i => i.id !== id);
                render();
                await saveData();
            }
        }

        // --- PRINT KANBAN CARDS ---
        function openPrintModal() {
            const sel = document.getElementById('print-select');
            sel.innerHTML = '';
            inventory.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.id;
                opt.innerText = i.name;
                sel.appendChild(opt);
            });
            document.getElementById('print-setup').style.display = 'flex';
        }

        function preparePrint(type) {
            const id = document.getElementById('print-select').value;
            const item = inventory.find(i => i.id === id);
            if(!item) return;

            const printArea = document.getElementById('print-area');
            printArea.innerHTML = '';

            const actionCode = `${item.id}-${type}`; 
            
            const title = type === 'red' ? "üõë DO≈†LO TO!" : "‚ö†Ô∏è DOCH√ÅZ√ç!";
            const desc = type === 'red' 
                ? `Vlo≈æte p≈ôed posledn√≠ kus.<br>P≈ôi odebr√°n√≠ naskenujte.<br><b>${item.name}</b>`
                : `Vlo≈æte p≈ôed posledn√≠ch 3-5 ks.<br>P≈ôi odebr√°n√≠ naskenujte.<br><b>${item.name}</b>`;

            const card = document.createElement('div');
            card.className = 'kanban-card';
            card.innerHTML = `
                <div class="kc-title">${title}</div>
                <div class="kc-desc">${desc}</div>
                <svg id="bc-print"></svg>
                <div style="margin-top:5px; font-family:monospace;">${actionCode}</div>
            `;
            printArea.appendChild(card);
            
            JsBarcode("#bc-print", actionCode, { format: "CODE128", displayValue: false, height: 50 });

            setTimeout(() => {
                window.print();
                document.getElementById('print-setup').style.display = 'none';
                printArea.innerHTML = ''; 
            }, 500);
        }

        // --- SCANNER LOGIC ---
        function startScanner() {
            document.getElementById('scanner-modal').style.display = 'flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
        }
        function stopScanner() {
            document.getElementById('scanner-modal').style.display = 'none';
            if(html5QrCode) html5QrCode.stop();
        }

        function onScanSuccess(decodedText) {
            stopScanner();
            
            const parts = decodedText.split('-');
            if(parts.length === 2) {
                const id = parts[0];
                const action = parts[1];
                const item = inventory.find(i => i.id === id);
                if(item) {
                    setStatus(id, action);
                    alert(`‚úÖ Aktualizov√°no: ${item.name} -> ${action === 'red' ? 'KOUPIT' : 'DOCH√ÅZ√ç'}`);
                    return;
                }
            }
            document.getElementById('search').value = decodedText;
            render();
            alert("K√≥d nenalezen nebo neplatn√Ω form√°t Kanban karty.");
        }

        // --- EMAIL ---
        function sendEmail() {
            const btn = document.getElementById('btnEmail');
            const toBuy = inventory.filter(i => i.status === 'red' || i.status === 'yellow');
            
            if(toBuy.length === 0) return alert("V≈°e OK, nic nechyb√≠.");
            
            // Sestaven√≠ seznamu pro email
            const list = toBuy.map(i => `- ${i.name} (${i.status==='red'?'NUTN√â!':'doch√°z√≠'})`).join('\n');
            
            btn.innerText = "Odes√≠l√°m...";
            btn.disabled = true;

            // Odesl√°n√≠ p≈ôes EmailJS
            emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, {
                message: list
            })
            .then(() => {
                alert("Seznam √∫spƒõ≈°nƒõ odesl√°n na email! üìß");
                btn.innerText = "üìß Odeslat";
                btn.disabled = false;
            }, (err) => {
                alert("Chyba odes√≠l√°n√≠: " + JSON.stringify(err));
                btn.innerText = "üìß Odeslat";
                btn.disabled = false;
            });
        }

    </script>
</body>
</html>
