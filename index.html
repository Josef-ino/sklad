<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sklad App</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --bg: #f3f4f6; --card-bg: #ffffff; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* LOGIN */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .login-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 320px; text-align: center; }
        .login-box input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1.1rem; }
        .btn-login { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }

        /* APP */
        #app-content { display: none; }
        header { background: var(--card-bg); padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; gap: 10px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); }
        .search-bar { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 12px; font-size: 1rem; outline: none; }
        .btn-icon { background: var(--primary); color: white; border: none; border-radius: 12px; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; cursor: pointer; }

        /* SKENER & GRID */
        #scanner-container { width: 100%; max-width: 500px; margin: 0 auto; display: none; background: black; position: relative; }
        #reader { width: 100%; }
        .close-scanner { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.8); border: none; padding: 10px; border-radius: 50%; z-index: 10; font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 15px; max-width: 800px; margin: 0 auto; }
        @media (min-width: 640px) { .grid { grid-template-columns: repeat(2, 1fr); } }
        
        .card { background: var(--card-bg); border-radius: 16px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; position: relative; border: 2px solid transparent; transition: transform 0.2s; }
        .card.empty { border-color: var(--danger); background-color: #fef2f2; }
        .empty-badge { position: absolute; top: -10px; background: var(--danger); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: none; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3); }
        .card.empty .empty-badge { display: block; }
        .item-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 5px; text-align: center; }
        .item-code { font-family: monospace; color: #6b7280; font-size: 0.9rem; margin-bottom: 10px; }
        .controls { display: flex; align-items: center; gap: 15px; width: 100%; justify-content: center; margin-top: 10px; }
        .btn-circle { width: 48px; height: 48px; border-radius: 50%; border: none; font-size: 1.5rem; display: flex; justify-content: center; align-items: center; cursor: pointer; touch-action: manipulation; }
        .btn-minus { background: #e5e7eb; color: var(--text); }
        .btn-plus { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        .count-display { font-size: 1.5rem; font-weight: 800; min-width: 40px; text-align: center; }
        .barcode-svg { width: 100%; max-width: 200px; height: 50px; }
        .btn-del { background: none; border: none; color: #9ca3af; font-size: 0.8rem; margin-top: 10px; text-decoration: underline; cursor: pointer; }

        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--success); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.4); border: none; z-index: 90; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; justify-content: center; align-items: flex-end; }
        .modal { background: white; width: 100%; max-width: 600px; padding: 25px; border-radius: 20px 20px 0 0; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal input { width: 100%; margin-bottom: 15px; padding: 10px; font-size: 1.1rem; border: 1px solid #ddd; border-radius: 8px;}
        .modal-btns { display: flex; gap: 10px; }
        .btn-full { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-primary { background: var(--success); color: white; }
        .btn-secondary { background: #e5e7eb; color: var(--text); }

        @media print {
            body * { visibility: hidden; }
            .grid, .grid * { visibility: visible; }
            body { background: white; padding: 0; margin: 0; }
            .grid { display: block; padding: 0; margin: 0; width: 100%; }
            .card { float: left; width: 48mm; height: 28mm; margin: 2mm; padding: 1mm; border: 1px dashed #000; border-radius: 0; box-shadow: none; background: white !important; page-break-inside: avoid; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
            .controls, .btn-del, .empty-badge, header, .fab, #scanner-container, #login-overlay { display: none !important; }
            .item-name { font-size: 10pt; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
            .barcode-svg { height: 12mm; width: 90%; }
            .item-code { font-size: 12pt; font-weight: bold; margin: 0; color: black; }
        }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-box">
            <h2>üîê Sklad Login</h2>
            <input type="text" id="loginUser" placeholder="U≈æivatelsk√© jm√©no">
            <input type="password" id="loginPass" placeholder="Heslo">
            <button class="btn-login" onclick="checkLogin()">Vstoupit</button>
            <p id="loginError" style="color:red; display:none; margin-top:10px;">≈†patn√© √∫daje!</p>
        </div>
    </div>

    <div id="app-content">
        <header>
            <div class="header-top">
                <h1>üì¶ Sklad <span id="syncStatus" style="font-size:0.8rem; color:#666; margin-left:10px;">...</span></h1>
                <button class="btn-icon" onclick="window.print()" title="Tisk">üñ®Ô∏è</button>
            </div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Hledat..." oninput="renderItems()">
                <button class="btn-icon" onclick="startScanner()" title="Skenovat">üì∑</button>
            </div>
        </header>

        <div id="scanner-container">
            <button class="close-scanner" onclick="stopScanner()">Zav≈ô√≠t kameru X</button>
            <div id="reader"></div>
        </div>

        <div id="inventoryList" class="grid"></div>
        <button class="fab" onclick="openModal()">+</button>

        <div class="modal-overlay" id="addModal">
            <div class="modal">
                <h2>Nov√Ω produkt</h2>
                <label>N√°zev:</label>
                <input type="text" id="newName" placeholder="Nap≈ô. Cukr krupice">
                <label>Poƒçet:</label>
                <input type="number" id="newCount" value="1">
                <div class="modal-btns">
                    <button class="btn-full btn-secondary" onclick="closeModal()">Zru≈°it</button>
                    <button class="btn-full btn-primary" onclick="addItem()">Ulo≈æit</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURACE A PROMƒöNN√â (MUS√ç B√ùT PRVN√ç!) ---
        const USER = "dole";
        const PASS = "01";
        const PANTRY_ID = "7a5aa8af-6120-4aef-9372-9520d1fb3f2d";
        const BASKET_NAME = "sklad";
        const API_URL = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`;

        let inventory = [];
        let html5QrCode;

        // --- 2. P≈òIHLA≈†OV√ÅN√ç ---
        function checkLogin() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            if(u === USER && p === PASS) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                localStorage.setItem('sklad_logged_in', 'true');
                loadData();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // Automatick√© p≈ôihl√°≈°en√≠, pokud u≈æ je ulo≈æeno
        if(localStorage.getItem('sklad_logged_in') === 'true') {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            // Tady to teƒè u≈æ nespadne, proto≈æe API_URL je definovan√© naho≈ôe
            loadData();
        }

        // --- 3. SKLADOV√Å LOGIKA ---
        async function loadData() {
            updateStatus("Naƒç√≠t√°m...");
            try {
                const res = await fetch(API_URL + "?t=" + Date.now());
                if(res.ok) {
                    const data = await res.json();
                    inventory = data.items || [];
                } else { inventory = []; }
                renderItems();
                updateStatus("Online ‚úÖ");
            } catch(e) {
                updateStatus("Offline ‚ùå");
                console.error(e);
            }
        }

        async function saveData() {
            updateStatus("Ukl√°d√°m...");
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ items: inventory })
                });
                updateStatus("Ulo≈æeno ‚úÖ");
            } catch(e) { updateStatus("Chyba ‚ùå"); }
        }

        function updateStatus(msg) { document.getElementById('syncStatus').innerText = msg; }

        function renderItems() {
            const list = document.getElementById('inventoryList');
            const term = document.getElementById('searchInput').value.toLowerCase().trim();
            list.innerHTML = '';

            const filtered = inventory.filter(i => 
                i.name.toLowerCase().includes(term) || i.id === term
            );

            filtered.sort((a,b) => (a.count === 0) === (b.count === 0) ? 0 : a.count === 0 ? -1 : 1);

            filtered.forEach(item => {
                const isEmpty = item.count === 0;
                const div = document.createElement('div');
                div.className = `card ${isEmpty ? 'empty' : ''}`;
                div.innerHTML = `
                    <div class="empty-badge">DOKOUPIT!</div>
                    <div class="item-name">${item.name}</div>
                    <svg class="barcode-svg" id="bc-${item.id}"></svg>
                    <div class="item-code">#${item.id}</div>
                    <div class="controls">
                        <button class="btn-circle btn-minus" onclick="updateCount('${item.id}', -1)">-</button>
                        <span class="count-display">${item.count}</span>
                        <button class="btn-circle btn-plus" onclick="updateCount('${item.id}', 1)">+</button>
                    </div>
                    <button class="btn-del" onclick="deleteItem('${item.id}')">smazat polo≈æku</button>
                `;
                list.appendChild(div);
                JsBarcode(`#bc-${item.id}`, item.id, { format: "CODE128", displayValue: false, margin: 0, height: 50 });
            });
        }

        function generateCode() {
            let id;
            do { id = Math.floor(Math.random()*1000).toString().padStart(3,'0'); } while(inventory.some(i => i.id === id));
            return id;
        }

        async function addItem() {
            const name = document.getElementById('newName').value;
            const count = parseInt(document.getElementById('newCount').value);
            if(!name) return;
            inventory.push({ id: generateCode(), name, count });
            closeModal(); renderItems(); await saveData();
        }

        async function updateCount(id, change) {
            const item = inventory.find(i => i.id === id);
            if(item) {
                item.count = Math.max(0, item.count + change);
                renderItems(); saveData();
            }
        }

        async function deleteItem(id) {
            if(confirm("Smazat?")) {
                inventory = inventory.filter(i => i.id !== id);
                renderItems(); await saveData();
            }
        }

        function openModal() {
            document.getElementById('addModal').style.display = 'flex';
            document.getElementById('newName').value = '';
            document.getElementById('newCount').value = 1;
            document.getElementById('newName').focus();
        }
        function closeModal() { document.getElementById('addModal').style.display = 'none'; }

        function startScanner() {
            const container = document.getElementById('scanner-container');
            container.style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } }, onScanSuccess)
            .catch(err => { alert("Kamera nedostupn√°."); container.style.display = 'none'; });
        }
        function stopScanner() {
            if(html5QrCode) html5QrCode.stop().then(() => document.getElementById('scanner-container').style.display = 'none');
            else document.getElementById('scanner-container').style.display = 'none';
        }
        function onScanSuccess(decodedText) {
            stopScanner();
            document.getElementById('searchInput').value = decodedText;
            renderItems();
            const item = inventory.find(i => i.id === decodedText);
            if(!item && confirm(`K√≥d ${decodedText} nen√≠ ve skladu. P≈ôidat?`)) openModal();
        }
    </script>
</body>
</html>
