<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kanban Sklad</title>
    <!-- Knihovny -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        :root {
            --ok: #10B981; --warn: #F59E0B; --crit: #EF4444;
            --bg: #F3F4F6; --text: #1F2937;
        }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }

        /* HEADER */
        header { background: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.2rem; color: #333; }
        
        /* SEARCH & TOOLS */
        .tools { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .btn-icon { width: 44px; height: 44px; background: #3B82F6; color: white; border: none; border-radius: 8px; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center;}

        /* LIST */
        .grid { display: grid; grid-template-columns: 1fr; gap: 10px; padding: 15px; max-width: 800px; margin: 0 auto; }
        @media(min-width:600px) { .grid { grid-template-columns: 1fr 1fr; } }
        
        .card { 
            background: white; padding: 15px; border-radius: 12px; 
            border-left: 10px solid var(--ok); box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .card[data-status="warn"] { border-left-color: var(--warn); background: #FFFBEB; }
        .card[data-status="crit"] { border-left-color: var(--crit); background: #FEF2F2; }

        .item-name { font-weight: bold; font-size: 1.1rem; }
        .item-status { font-size: 0.8rem; color: #666; margin-top: 4px; font-weight: bold; text-transform: uppercase; }

        /* TLAƒå√çTKA */
        .btn-reset { padding: 8px 15px; background: #E5E7EB; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: #3B82F6; color: white; border-radius: 50%; border: none; font-size: 2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index:90; }
        .btn-email { position: fixed; bottom: 20px; left: 20px; height: 60px; padding: 0 20px; background: #10B981; color: white; border-radius: 30px; border: none; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index:90; }

        /* SKENER UI */
        #scanner-ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; display: none; }
        #reader { width: 100%; height: 80%; }
        .close-scan { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; background: white; border: none; border-radius: 30px; font-weight: bold; }

        /* --- OPRAVEN√â CSS PRO TISK --- */
        #print-area { display: none; } /* Norm√°lnƒõ skryt√© */

        @media print {
            /* Skryje √∫plnƒõ v≈°echno na str√°nce */
            body > * { display: none !important; }
            
            /* Zobraz√≠ JEN tiskovou oblast */
            #print-area { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr; 
                gap: 15px; 
                position: absolute; 
                top: 0; 
                left: 0; 
                width: 100%; 
                background: white;
                padding: 10px;
                box-sizing: border-box;
            }
            
            /* Styly pro kartiƒçky p≈ôi tisku */
            .print-card { 
                display: flex !important;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border: 2px dashed black; 
                padding: 10px; 
                text-align: center; 
                break-inside: avoid; /* Nerozdƒõlovat na str√°nky */
                height: 140px; 
                page-break-inside: avoid;
            }
            
            .print-title { font-size: 14pt; font-weight: bold; margin-bottom: 5px; color: black; }
            .print-instruction { font-size: 10pt; font-weight: bold; background: black; color: white; padding: 2px 8px; margin-bottom: 5px; border-radius: 4px; }
            .print-code { font-family: monospace; font-size: 10pt; margin-top: 5px; color: black; }
            svg { width: 100%; max-height: 50px; display: block; }
        }
    </style>
</head>
<body>

    <!-- P≈òIHL√Å≈†EN√ç -->
    <div id="login-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f3f4f6; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:20px; text-align:center; width:300px;">
            <h2>üîê Kanban</h2>
            <input type="password" id="pass" placeholder="Heslo (01)" style="width:100%; margin-bottom:10px; padding:10px;">
            <button onclick="if(document.getElementById('pass').value==='01'){this.parentElement.parentElement.style.display='none'; loadData();}" style="width:100%; padding:10px; background:#2563eb; color:white; border:none; border-radius:10px;">Vstoupit</button>
        </div>
    </div>

    <!-- UI -->
    <header>
        <div class="header-top">
            <h1>üì¶ Sklad <span id="status" style="font-size:0.8rem">...</span></h1>
            <button class="btn-icon" onclick="preparePrint()" title="Tisk">üñ®Ô∏è</button>
        </div>
        <div class="tools">
            <input type="text" id="search" placeholder="üîç Hledat..." oninput="render()">
            <button class="btn-icon" onclick="startScanner()">üì∑</button>
        </div>
    </header>

    <div id="list" class="grid"></div>

    <button class="btn-email" onclick="sendEmailViaService()" id="btnSend">üìß Odeslat</button>
    <button class="fab" onclick="addItemPrompt()">+</button>

    <!-- SKENER -->
    <div id="scanner-ui">
        <div id="reader"></div>
        <button class="close-scan" onclick="stopScanner()">Zav≈ô√≠t</button>
    </div>

    <!-- TISK -->
    <div id="print-area"></div>

    <script>
        // --- KONFIGURACE ---
        const USER = "dole";
        const PASS = "01";
        const PANTRY_ID = "7a5aa8af-6120-4aef-9372-9520d1fb3f2d";
        const API_URL = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/kanban`;

        const EMAIL_SERVICE_ID = "service_wzg8ove";
        const EMAIL_TEMPLATE_ID = "template_71jc7wb";
        const EMAIL_PUBLIC_KEY = "o1EMgg8G3ffAloJPI";

        let inventory = [];
        let scanner;

        // Init EmailJS
        (function() { try { emailjs.init(EMAIL_PUBLIC_KEY); } catch(e){} })();

        // --- DATA ---
        async function loadData() {
            document.getElementById('status').innerText = "Naƒç√≠t√°m...";
            try {
                const res = await fetch(API_URL + "?t=" + Date.now());
                if(res.ok) {
                    const data = await res.json();
                    inventory = data.items || [];
                }
                render();
                document.getElementById('status').innerText = "‚úÖ";
            } catch(e) { document.getElementById('status').innerText = "‚ùå Offline"; }
        }

        async function saveData() {
            document.getElementById('status').innerText = "Ukl√°d√°m...";
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ items: inventory })
                });
                document.getElementById('status').innerText = "‚úÖ";
            } catch(e) {}
        }

        // --- RENDER ---
        function render() {
            const list = document.getElementById('list');
            const term = document.getElementById('search').value.toLowerCase();
            list.innerHTML = '';

            const sorted = inventory.filter(i => i.name.toLowerCase().includes(term)).sort((a,b) => {
                const score = { 'crit': 2, 'warn': 1, 'ok': 0 };
                return score[b.status] - score[a.status];
            });

            sorted.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.setAttribute('data-status', item.status);
                
                let statusText = "‚úÖ M√°m dost";
                if(item.status === 'warn') statusText = `‚ö†Ô∏è DOCH√ÅZ√ç (Zbylo cca ${item.warnAt} ks)`;
                if(item.status === 'crit') statusText = `‚õî KRITICK√â (Zbylo ${item.critAt} ks - KOUPIT!)`;

                div.innerHTML = `
                    <div style="flex:1">
                        <div class="item-name">${item.name}</div>
                        <div class="item-status">${statusText}</div>
                    </div>
                    ${item.status !== 'ok' ? `<button class="btn-reset" onclick="resetItem('${item.id}')">Nakoupeno (Reset)</button>` : ''}
                    <button style="background:none; border:none; color:#ccc; margin-left:10px;" onclick="deleteItem('${item.id}')">üóëÔ∏è</button>
                `;
                list.appendChild(div);
            });
        }

        function generateCode() { return Math.floor(Math.random()*1000).toString().padStart(3,'0'); }

        function addItemPrompt() {
            const name = prompt("N√°zev produktu:");
            if(!name) return;
            inventory.push({ id: generateCode(), name: name, status: 'ok', warnAt: 3, critAt: 0 });
            saveData(); render();
        }

        function resetItem(id) {
            const item = inventory.find(i => i.id === id);
            if(item) { item.status = 'ok'; saveData(); render(); }
        }

        function deleteItem(id) {
            if(confirm("Smazat?")) {
                inventory = inventory.filter(i => i.id !== id);
                saveData(); render();
            }
        }

        // --- SKENER ---
        function processCode(code) {
            const parts = code.split('-');
            if(parts.length !== 2) return alert("Nezn√°m√Ω k√≥d: " + code);
            const id = parts[0];
            const type = parts[1]; 
            const item = inventory.find(i => i.id === id);
            if(!item) return alert("Produkt nenalezen!");

            if(type === 'W') { item.status = 'warn'; alert(`‚ö†Ô∏è ${item.name} doch√°z√≠!`); } 
            else if (type === 'C') { item.status = 'crit'; alert(`‚õî ${item.name} je KRITICK√â!`); }
            saveData(); render();
        }

        function startScanner() {
            document.getElementById('scanner-ui').style.display = 'block';
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10 }, (decodedText) => {
                stopScanner(); processCode(decodedText);
            });
        }
        function stopScanner() {
            document.getElementById('scanner-ui').style.display = 'none';
            if(scanner) scanner.stop();
        }

        // --- TISK (OPRAVENO) ---
        function preparePrint() {
            const area = document.getElementById('print-area');
            area.innerHTML = '';
            
            // POJISTKA: Pokud nen√≠ co tisknout
            if(inventory.length === 0) {
                alert("Seznam je pr√°zdn√Ω! Nejd≈ô√≠ve p≈ôidejte produkty tlaƒç√≠tkem +");
                return;
            }

            // Generov√°n√≠ kartiƒçek do skryt√©ho divu
            inventory.forEach(item => {
                // Karta VAROV√ÅN√ç
                area.innerHTML += `
                    <div class="print-card">
                        <div class="print-title">${item.name}</div>
                        <div class="print-instruction">VLO≈ΩIT MEZI POSLEDN√çCH ${item.warnAt} KS</div>
                        <svg class="barcode" data-code="${item.id}-W"></svg>
                        <div class="print-code">${item.id}-W (DOCH√ÅZ√ç)</div>
                    </div>
                `;
                // Karta KRITICK√â
                area.innerHTML += `
                    <div class="print-card" style="border-width:4px;">
                        <div class="print-title">${item.name}</div>
                        <div class="print-instruction">POSLEDN√ç KUS / PR√ÅZDN√â</div>
                        <svg class="barcode" data-code="${item.id}-C"></svg>
                        <div class="print-code">${item.id}-C (KRITICK√â)</div>
                    </div>
                `;
            });

            // Vykreslen√≠ ƒç√°rov√Ωch k√≥d≈Ø
            document.querySelectorAll('#print-area svg').forEach(svg => {
                try {
                    JsBarcode(svg, svg.dataset.code, { 
                        format: "CODE128", 
                        displayValue: false, 
                        height: 40,
                        margin: 0
                    });
                } catch(e) { console.error("Chyba barcodu", e); }
            });

            // D≈Øle≈æit√©: ƒåek√°me 1 vte≈ôinu, aby se v≈°e vykreslilo, ne≈æ spust√≠me tisk
            setTimeout(() => {
                window.print();
            }, 1000);
        }

        // --- EMAIL ---
        function sendEmailViaService() {
            const toBuy = inventory.filter(i => i.status !== 'ok');
            if(toBuy.length === 0) return alert("V≈°e je OK, n√°kup nen√≠ pot≈ôeba.");

            const btn = document.getElementById('btnSend');
            btn.innerText = "Odes√≠l√°m...";
            btn.disabled = true;

            const list = toBuy.map(i => `- ${i.name} (${i.status === 'crit' ? 'NUTN√â!!' : 'doch√°z√≠'})`).join('\n');

            emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, { message: list })
            .then(() => { alert("‚úÖ Odesl√°no!"); btn.innerText = "üìß Odeslat"; btn.disabled = false; }, 
                  (err) => { alert("‚ùå Chyba: " + JSON.stringify(err)); btn.innerText = "üìß Odeslat"; btn.disabled = false; });
        }
    </script>
</body>
</html>
